{% extends "layouts/base.html" %} {% set title %}Results{% endset %} {% set
style %}main.css{% endset %} {% block body %}
<div class="center_us">
  <br /><br />
  <div id="TamarOutput">
    <h1>Tamar's output (delete after)</h1>
    <p>Required: {{required}}</p>
    <p>Optional: {{optional}}</p>
  </div>
  <div id="AudreyOutput">
    <h1>Audrey's output (delete after)</h1>
    <p>Routes: {{routes}}</p>
    <p>Total trip time: {{total_trip_time}}</p>
  </div>

  <h1>Results for your trip!</h1>
  {% if routes.length == 0 %}
  <h2>No results found!</h2>
  {% else %}
  <div id="route-results" class="result-sections">
    <h2 class="result-title">Optimized Route</h2>
    <p>Total time on the road: {{travel_time}} minutes</p>
    <p>Total time at the {{num_sites}} sites: {{visit_time}} minutes</p>
    {% for route in routes %}
    <div class="one-result" id="route_{{loop.index}}">
      <h3>Day {{loop.index}}:</h3>
      <div class="maps"></div>
      {% for place in route[:route|length - 1] %}
      <span id="{{place['name']}}${{place['lat']}}${{place['long']}}">
        {{place['name']}} for {{place['visit_time']}} minutes ->
      </span>
      {% endfor %}
      <span
        id="{{route[route|length - 1]['name']}}${{route[route|length - 1]['lat']}}${{route[route|length - 1]['long']}}"
      >
        {{ route[route|length - 1]['name'] }} for {{route[route|length -
        1]['visit_time']}} minutes
      </span>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <script
    async
    src="http://maps.googleapis.com/maps/api/js?v=3.exp&key={{google_key}}&sensor=false&libraries=places"
  ></script>
  <script>
    const allMaps = document.getElementsByClassName("maps");
    const allMapObjects = {};

    window.addEventListener("load", (e) => {
      let i = 1;

      const googleMethods = new Map();
      googleMethods.set("car", google.maps.TravelMode.DRIVING);
      googleMethods.set("bike", google.maps.TravelMode.BICYCLING);
      googleMethods.set("walking", google.maps.TravelMode.WALKING);
      googleMethods.set("public transport", google.maps.TravelMode.TRANSIT);

      let transportation = googleMethods.get("{{transport}}");
      let map, marker, directionsService, directionsRenderer;
      let div_holding_everything,
        spans_for_map,
        info,
        location,
        stops,
        origin,
        destination;

      // Make one map for every day
      for (const mapNode of allMaps) {
        map = new google.maps.Map(mapNode, {
          center: { lat: -34.397, lng: 150.644 },
          zoom: 8,
        });
        allMapObjects[map] = [];

        // Router that will connect all the stops for the day
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        // Add markers for all the locations visited that day
        div_holding_everything = document.getElementById("route_" + i);
        spans_for_map = div_holding_everything.querySelectorAll("span");
        stops = [];
        for (let span of spans_for_map) {
          info = span.id.split("$");
          stops.push({
            location: { lat: parseFloat(info[1]), lng: parseFloat(info[2]) },
            stopover: true,
          });
        }

        origin = stops.shift().location;
        destination = stops.pop().location;
        console.log(origin, destination, stops, transportation);
        directionsService.route(
          {
            origin: origin,
            destination: destination,
            waypoints: stops,
            travelMode: transportation,
          },
          function (response, status) {
            if (status === "OK") {
              directionsRenderer.setDirections(response);
            } else {
              alert("Directions request failed due to " + status);
            }
          }
        );

        map.setCenter(origin.location);
        map.setZoom(17);
        console.log("HERE");
        i++;
      }
    });
  </script>
</div>
{% endblock %}
